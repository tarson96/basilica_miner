# Basilica Configuration Files

This directory contains configuration files for all Basilica services. These configurations are generated by the provisioning system and customized for specific environments.

## üìÅ Directory Structure

```
configs/
‚îú‚îÄ‚îÄ README.md                    # This file
‚îú‚îÄ‚îÄ *.toml.example              # Example configuration templates
‚îú‚îÄ‚îÄ *.toml                      # Actual configuration files (gitignored)
‚îú‚îÄ‚îÄ secrets.toml                # Secret values (gitignored)
‚îî‚îÄ‚îÄ systemd/                    # Systemd service definitions
    ‚îú‚îÄ‚îÄ basilica-executor.service
    ‚îú‚îÄ‚îÄ basilica-miner.service
    ‚îî‚îÄ‚îÄ basilica-validator.service
```

## üîß Configuration Files

### Core Service Configurations

#### `executor.toml`
Configuration for GPU executor machines:
- **gRPC server settings** (port 50051)
- **Docker integration** with GPU support
- **System monitoring** (CPU, GPU, memory, network)
- **Security settings** and allowed IPs
- **Resource limits** for containers
- **SSH validation** configuration

#### `miner.toml` 
Configuration for miner fleet managers:
- **Bittensor integration** (wallet, hotkey, network)
- **Executor fleet management** 
- **gRPC and Axon servers**
- **Authentication and security**
- **Remote deployment** settings
- **Health monitoring**

#### `validator.toml`
Configuration for validation nodes:
- **Bittensor network participation**
- **REST API server** (port 8080)
- **SSH validation protocol**
- **Database configuration**
- **Scoring and consensus**
- **Security and authentication**

### Secret Management

#### `secrets.toml`
Contains sensitive configuration values:
- **Bittensor wallet credentials**
- **JWT secrets** for authentication
- **SSH private keys** paths
- **TLS certificates** and keys
- **Database encryption** keys
- **Production IP addresses**

**‚ö†Ô∏è SECURITY WARNING**: This file contains sensitive data and is automatically added to `.gitignore`. Never commit secrets to version control!

## üöÄ Quick Start

### 1. Generate Configuration Files

Use the provisioning system to generate configurations:

```bash
# Generate all configurations for production
./scripts/basilica.sh provision configure --env production

# Generate configurations for specific service
./scripts/provision/configure.sh generate validator --env production
```

### 2. Customize Configurations

Copy example files and customize for your environment:

```bash
# Copy example configurations
cp executor.toml.example executor.toml
cp miner.toml.example miner.toml  
cp validator.toml.example validator.toml
cp secrets.toml.example secrets.toml

# Edit with your specific values
vim executor.toml
vim miner.toml
vim validator.toml
vim secrets.toml  # Add your actual secrets
```

### 3. Deploy Configurations

Deploy configurations to servers:

```bash
# Deploy all configurations
./scripts/basilica.sh deploy config

# Deploy specific configuration
./scripts/provision/configure.sh deploy --service validator --env production
```

## üîí Security Best Practices

### Secret Management

1. **Never commit secrets**: All `.toml` files (except `.example`) are gitignored
2. **Use dedicated users**: Don't run services as root in production
3. **Rotate keys regularly**: Update SSH keys and JWT secrets periodically
4. **Encrypt sensitive data**: Use encrypted storage for private keys

### File Permissions

Set appropriate permissions for configuration files:

```bash
# Configuration files - readable by service user only
chmod 600 *.toml
chown basilica:basilica *.toml

# SSH keys - very restrictive
chmod 400 /etc/basilica/keys/*
chown basilica:basilica /etc/basilica/keys/*

# Systemd services - root owned
chmod 644 systemd/*.service
chown root:root systemd/*.service
```

### Network Security

Configure firewalls and network access:

```bash
# Validator (external API access)
ufw allow 8080/tcp   # API server
ufw allow 9090/tcp   # Metrics (restrict to monitoring network)

# Miner (Bittensor network)  
ufw allow 8091/tcp   # Axon server
ufw allow 8092/tcp   # gRPC server

# Executor (internal network only)
ufw allow 50051/tcp  # gRPC server (restrict to miner IPs)
```

## üìã Configuration Reference

### Common Settings

#### Server Configuration
```toml
[server]
host = "0.0.0.0"        # Bind address
port = 8080             # Service port
max_connections = 1000  # Connection limit
request_timeout = 30    # Request timeout in seconds
```

#### Database Configuration
```toml
[database]
url = "sqlite:/path/to/database.db"
max_connections = 10
run_migrations = true
backup_enabled = true
```

#### Logging Configuration
```toml
[logging]
level = "info"          # trace, debug, info, warn, error
format = "json"         # json, pretty, compact
enable_file_logging = true
log_dir = "/var/log/basilica"
```

#### Metrics Configuration
```toml
[metrics]
enabled = true
port = 9090
collection_interval = 30  # seconds
```

### Service-Specific Settings

#### Executor Configuration
```toml
[docker]
socket_path = "/var/run/docker.sock"
enable_gpu_support = true
network_name = "basilica"

[resources]
max_containers = 10
max_memory_per_container = "8g"
max_cpu_per_container = 4.0
gpu_allocation_strategy = "exclusive"
```

#### Miner Configuration
```toml
[bittensor]
wallet_name = "miner"
hotkey_name = "default"
network = "finney"
netuid = 39
external_ip = "203.0.113.1"

[executor_management]
health_check_interval = "60s"
auto_recovery = true
```

#### Validator Configuration
```toml
[validation]
max_concurrent_validations = 10
validation_timeout = 120
min_score_threshold = 0.1
verification_interval = 600

[scoring]
min_stake_threshold = 1000.0
max_miners_to_validate = 20
weight_update_interval = 300
```

## üîß Troubleshooting

### Common Configuration Issues

#### Invalid TOML Syntax
```bash
# Validate TOML syntax
python3 -c "import toml; toml.load('validator.toml')"

# Or use online TOML validator
# https://www.toml-lint.com/
```

#### Missing Secret Values
```bash
# Check for placeholder values
grep -r "YOUR_.*_HERE" *.toml
grep -r "REPLACE_WITH" *.toml

# Validate required secrets
./scripts/provision/configure.sh validate --check-secrets
```

#### Permission Issues
```bash
# Fix configuration file permissions
sudo chown -R basilica:basilica /etc/basilica/
sudo chmod -R 600 /etc/basilica/*.toml
sudo chmod -R 400 /etc/basilica/keys/
```

#### Network Configuration
```bash
# Test network connectivity
telnet validator_ip 8080
telnet miner_ip 8092  
telnet executor_ip 50051

# Check firewall rules
sudo ufw status verbose
```

### Validation Commands

The provisioning system includes validation commands:

```bash
# Validate all configurations
./scripts/provision/validate.sh config

# Validate specific service
./scripts/provision/validate.sh config --service validator

# Check for security issues
./scripts/provision/validate.sh security
```

## üìö Environment-Specific Configuration

### Development Environment
- Uses `local` Bittensor network
- Simplified security settings
- Local file paths
- Debug logging enabled

### Staging Environment  
- Uses `test` Bittensor network
- Production-like security
- Staging server IPs
- Info-level logging

### Production Environment
- Uses `finney` Bittensor network
- Full security hardening
- Production server IPs
- Optimized for performance

## üîÑ Configuration Updates

### Updating Configurations

1. **Backup current configs**: Always backup before changes
2. **Update templates**: Modify `.example` files first
3. **Regenerate configs**: Use provisioning system to update
4. **Test changes**: Validate in development first
5. **Deploy gradually**: Update one service at a time

### Rolling Updates

```bash
# Update validator configuration
./scripts/provision/configure.sh generate validator --env production
./scripts/provision/services.sh restart validator

# Update miner configuration  
./scripts/provision/configure.sh generate miner --env production
./scripts/provision/services.sh restart miner

# Update executor configuration
./scripts/provision/configure.sh generate executor --env production
./scripts/provision/services.sh restart executor
```

This configuration system provides a secure, scalable foundation for deploying Basilica services across different environments while maintaining consistency and security best practices.