#!/bin/bash
# Certificate rotation script - Generated by Ansible
# This script rotates the self-signed SSL certificates for Nginx

set -e

CERT_DIR="/etc/nginx/ssl"
OLD_CERT="${CERT_DIR}/nginx_cert.pem"
OLD_KEY="${CERT_DIR}/nginx_key.pem"
BACKUP_DIR="${CERT_DIR}/backup_$(date +%Y%m%d_%H%M%S)"
DOMAIN="{{ basilica_domain | default(ansible_host) }}"

# Create backup directory
mkdir -p ${BACKUP_DIR}

# Backup existing certificates
if [ -f "${OLD_CERT}" ] && [ -f "${OLD_KEY}" ]; then
    echo "Backing up existing certificates to ${BACKUP_DIR}..."
    cp "${OLD_CERT}" "${BACKUP_DIR}/nginx_cert.pem.bak"
    cp "${OLD_KEY}" "${BACKUP_DIR}/nginx_key.pem.bak"
fi

# Generate new certificates
echo "Generating new self-signed SSL certificates..."
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -sha256 \
    -keyout "${OLD_KEY}" \
    -out "${OLD_CERT}" \
    -subj "/C={{ nginx_cert_country | default('US') }}/ST={{ nginx_cert_state | default('State') }}/L={{ nginx_cert_locality | default('City') }}/O={{ nginx_cert_organization | default('Basilica') }}/CN=${DOMAIN}"

# Set proper permissions
chmod 600 "${OLD_CERT}" "${OLD_KEY}"
chown root:root "${OLD_CERT}" "${OLD_KEY}"

# Reload Nginx
echo "Reloading Nginx to apply new certificates..."
nginx -t && systemctl reload nginx

echo "SSL certificate rotation completed successfully at $(date)"
exit 0